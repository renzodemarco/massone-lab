import PDFDocument from "pdfkit";

export const generateStyledReportPdf = (report, res) => {
  const doc = new PDFDocument({
    size: "A4",
    margins: { top: 50, left: 50, right: 50, bottom: 50 }
  });

  // Enviar directo al cliente (stream)
  doc.pipe(res);

  // Encabezado con logo y título
  doc
    .image("./assets/logo.png", 50, 40, { width: 80 })
    .fontSize(22)
    .fillColor("#2C3E50")
    .text("Veterinary Pathology Report", 150, 50, { align: "left" })
    .moveDown(2);

  // Línea separadora
  doc
    .moveTo(50, 120)
    .lineTo(550, 120)
    .strokeColor("#2980B9")
    .lineWidth(2)
    .stroke();

  // Sección datos básicos
  doc
    .moveDown()
    .fontSize(12)
    .fillColor("#000")
    .text(`Protocol Number: ${report.protocolNumber}`, { continued: true })
    .text(`   |   Status: ${report.status}`);

  doc.text(`Study Type: ${report.studyType}`);
  doc.text(`Entry Date: ${report.entryDate.toLocaleDateString()}`);
  doc.text(`Due Date: ${report.dueDate?.toLocaleDateString() || "-"}`);
  doc.moveDown(1.5);

  // Sección paciente en caja
  doc
    .rect(50, doc.y, 500, 120)
    .strokeColor("#BDC3C7")
    .lineWidth(1)
    .stroke();

  const startY = doc.y + 10;
  doc
    .fontSize(13)
    .fillColor("#2C3E50")
    .text("Patient Information", 60, startY, { underline: true });

  doc
    .fontSize(11)
    .fillColor("#000")
    .text(`Name: ${report.patient.name}`, 60, startY + 25)
    .text(`Owner: ${report.patient.owner}`)
    .text(`Species: ${report.patient.species}`)
    .text(`Breed: ${report.patient.breed}`)
    .text(`Age: ${report.patient.age}`)
    .text(`Sex: ${report.patient.sex}`)
    .text(`Color: ${report.patient.color}`)
    .text(`Neutered: ${report.patient.neutered ? "Yes" : "No"}`);
  doc.moveDown(3);

  // Secciones largas (macro, micro, resultados)
  const addSection = (title, content) => {
    if (!content) return;
    doc
      .fontSize(14)
      .fillColor("#2980B9")
      .text(title, { underline: true })
      .moveDown(0.5);
    doc.fontSize(11).fillColor("#000").text(content, { align: "justify" });
    doc.moveDown(1.5);
  };

  addSection("Macroscopic Description", report.macroDescription);
  addSection("Microscopic Description", report.microDescription);
  addSection("Result", report.result);
  addSection("Comments", report.comments);

  // Imágenes al final
  if (report.images?.length > 0) {
    doc
      .fontSize(14)
      .fillColor("#2980B9")
      .text("Images", { underline: true })
      .moveDown(1);

    report.images.forEach((img, i) => {
      try {
        doc.image(img, { fit: [200, 200], align: "center" });
        doc.moveDown(1);
      } catch {
        doc.fontSize(10).fillColor("red").text(`(Image not found: ${img})`);
      }
    });
  }

  // Pie de página
  doc
    .fontSize(10)
    .fillColor("#7F8C8D")
    .text("Generated by Veterinary System ©", 50, 780, {
      align: "center",
      width: 500
    });

  doc.end();
};
